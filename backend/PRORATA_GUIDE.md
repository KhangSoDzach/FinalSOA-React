# ğŸ“… Pro-rata Billing System (TÃ­nh phÃ­ theo tá»· lá»‡)

## ğŸ¯ Tá»•ng quan

**Pro-rata** lÃ  phÆ°Æ¡ng phÃ¡p tÃ­nh phÃ­ theo tá»· lá»‡ thá»i gian sá»­ dá»¥ng thá»±c táº¿. TÃ­nh nÄƒng nÃ y Cá»°C Ká»² QUAN TRá»ŒNG trong quáº£n lÃ½ tÃ²a nhÃ  vÃ¬:

- âœ… CÆ° dÃ¢n hiáº¿m khi chuyá»ƒn vÃ o Ä‘Ãºng ngÃ y mÃ¹ng 1
- âœ… CÃ´ng báº±ng: "á» bao nhiÃªu ngÃ y, tráº£ báº¥y nhiÃªu tiá»n"
- âœ… TuÃ¢n thá»§ quy Ä‘á»‹nh phÃ¡p luáº­t vá» há»£p Ä‘á»“ng thuÃª nhÃ 

---

## ğŸ“Š CÃ´ng thá»©c tÃ­nh toÃ¡n

### CÃ´ng thá»©c cÆ¡ báº£n

$$
\text{Tiá»n pháº£i tráº£} = \frac{\text{GiÃ¡ trá»n gÃ³i 1 thÃ¡ng}}{\text{Tá»•ng sá»‘ ngÃ y cá»§a thÃ¡ng}} \times \text{Sá»‘ ngÃ y sá»­ dá»¥ng}
$$

### Chi tiáº¿t

**Sá»‘ ngÃ y sá»­ dá»¥ng** = `(NgÃ y cuá»‘i thÃ¡ng - NgÃ y chuyá»ƒn vÃ o) + 1`

> **LÆ°u Ã½:** Pháº£i cá»™ng 1 vÃ¬ tÃ­nh cáº£ ngÃ y chuyá»ƒn vÃ o!

### VÃ­ dá»¥ thá»±c táº¿

**TÃ¬nh huá»‘ng:**
- PhÃ­ quáº£n lÃ½: 2,000,000Ä‘/thÃ¡ng
- CÆ° dÃ¢n chuyá»ƒn vÃ o: **20/10/2024**
- ThÃ¡ng 10 cÃ³ **31 ngÃ y**

**TÃ­nh toÃ¡n:**
- Sá»‘ ngÃ y á»Ÿ: `(31 - 20) + 1 = 12 ngÃ y`
- ÄÆ¡n giÃ¡ hÃ ng ngÃ y: `2,000,000 / 31 = 64,516.13Ä‘/ngÃ y`
- Tiá»n pháº£i Ä‘Ã³ng: `64,516.13 Ã— 12 = 774,193.55Ä‘`

---

## ğŸ—‚ï¸ PhÃ¢n loáº¡i dá»‹ch vá»¥

### 1. PhÃ­ cá»‘ Ä‘á»‹nh (Ãp dá»¥ng Pro-rata) âœ…

| Loáº¡i phÃ­ | MÃ´ táº£ | VÃ­ dá»¥ |
|----------|-------|-------|
| **PhÃ­ quáº£n lÃ½** | PhÃ­ duy trÃ¬ tÃ²a nhÃ  | 2,000,000Ä‘/thÃ¡ng |
| **PhÃ­ gá»­i xe** | VÃ© thÃ¡ng (Ã´ tÃ´/xe mÃ¡y/xe Ä‘áº¡p) | 1,500,000Ä‘/thÃ¡ng |
| **Internet** | GÃ³i cÃ¡p quang (náº¿u tÃ²a nhÃ  cung cáº¥p) | 300,000Ä‘/thÃ¡ng |
| **Tiá»‡n Ã­ch** | VÃ© Gym, Há»“ bÆ¡i thÃ¡ng | 500,000Ä‘/thÃ¡ng |

**NguyÃªn táº¯c:** CÃ¡c phÃ­ nÃ y tÃ­nh theo THÃNG â†’ Pháº£i chia tá»· lá»‡ náº¿u chuyá»ƒn vÃ o giá»¯a thÃ¡ng.

---

### 2. PhÃ­ theo má»©c tiÃªu thá»¥ (KHÃ”NG Ã¡p dá»¥ng Pro-rata) âŒ

| Loáº¡i phÃ­ | CÃ¡ch tÃ­nh | Ghi chÃº |
|----------|-----------|---------|
| **Äiá»‡n** | `(Chá»‰ sá»‘ cuá»‘i - Chá»‰ sá»‘ Ä‘áº§u) Ã— ÄÆ¡n giÃ¡` | TÃ­nh theo cÃ´ng tÆ¡ |
| **NÆ°á»›c** | `(Chá»‰ sá»‘ cuá»‘i - Chá»‰ sá»‘ Ä‘áº§u) Ã— ÄÆ¡n giÃ¡` | TÃ­nh theo cÃ´ng tÆ¡ |

**NguyÃªn táº¯c:** 
- KHÃ”NG chia ngÃ y, mÃ  tÃ­nh theo tiÃªu thá»¥ thá»±c táº¿
- Khi bÃ n giao nhÃ  giá»¯a thÃ¡ng â†’ Ghi láº¡i chá»‰ sá»‘ cÃ´ng tÆ¡ lÃ m "Chá»‰ sá»‘ Ä‘áº§u"
- Cuá»‘i thÃ¡ng â†’ Äá»c chá»‰ sá»‘ â†’ TÃ­nh tiá»n

---

### 3. Dá»‹ch vá»¥ láº» (TÃ­nh 100%) âš¡

| Dá»‹ch vá»¥ | CÃ¡ch tÃ­nh |
|---------|-----------|
| Dá»n dáº¹p theo giá» | GiÃ¡ Ã— Sá»‘ giá» |
| Sá»­a chá»¯a Ä‘iá»‡n/nÆ°á»›c | GiÃ¡ cá»‘ Ä‘á»‹nh/vá»¥ |
| ThuÃª BBQ | GiÃ¡ Ã— Sá»‘ giá» |

**NguyÃªn táº¯c:** KHÃ”NG liÃªn quan Ä‘áº¿n Pro-rata, luÃ´n tÃ­nh 100%.

---

## ğŸ’» Sá»­ dá»¥ng trong Code

### Import module

```python
from app.core.utils import (
    calculate_prorated_amount,
    is_full_month,
    get_billing_period,
    calculate_metered_consumption
)
from app.services.price_calculator import (
    calculate_management_fee,
    calculate_parking_fee
)
```

---

### 1. TÃ­nh phÃ­ quáº£n lÃ½ cÃ³ Pro-rata

```python
from datetime import date
from decimal import Decimal
from sqlmodel import Session
from app.models.apartment import Apartment
from app.core.utils import calculate_prorated_amount
from app.services.price_calculator import get_current_price
from app.models.price_history import PriceType

def generate_management_fee_bill(session: Session, apartment: Apartment, billing_month: date):
    """
    Táº¡o hÃ³a Ä‘Æ¡n phÃ­ quáº£n lÃ½ (cÃ³ Ã¡p dá»¥ng Pro-rata)
    """
    # 1. Láº¥y Ä‘Æ¡n giÃ¡ phÃ­ quáº£n lÃ½/mÂ² hiá»‡n táº¡i
    unit_price = get_current_price(
        session=session,
        price_type=PriceType.MANAGEMENT_FEE_PER_M2,
        reference_id=None
    )
    # VD: 35,000Ä‘/mÂ²
    
    # 2. TÃ­nh phÃ­ quáº£n lÃ½ trá»n gÃ³i 1 thÃ¡ng
    monthly_fee = unit_price * Decimal(str(apartment.area))
    # VD: 35,000 Ã— 65mÂ² = 2,275,000Ä‘
    
    # 3. Ãp dá»¥ng Pro-rata náº¿u chuyá»ƒn vÃ o giá»¯a thÃ¡ng
    amount = calculate_prorated_amount(
        monthly_fee=monthly_fee,
        billing_date=billing_month,  # VD: date(2024, 12, 31)
        move_in_date=apartment.move_in_date
    )
    
    # 4. Táº¡o Bill
    from app.models.bill import Bill, BillType
    
    bill = Bill(
        bill_number=f"MF-{apartment.apartment_number}-{billing_month.strftime('%Y%m')}",
        user_id=apartment.resident_id,
        bill_type=BillType.MANAGEMENT_FEE,
        title=f"PhÃ­ quáº£n lÃ½ thÃ¡ng {billing_month.month}/{billing_month.year}",
        description=f"CÄƒn há»™ {apartment.apartment_number} - {apartment.area}mÂ² Ã— {unit_price:,}Ä‘/mÂ²",
        amount=amount,
        due_date=billing_month + timedelta(days=15),
        status=BillStatus.PENDING
    )
    
    session.add(bill)
    session.commit()
    
    return bill


# ========== VÃ Dá»¤ Sá»¬ Dá»¤NG ==========
apartment = session.get(Apartment, apartment_id)

# Case 1: Chuyá»ƒn vÃ o Ä‘áº§u thÃ¡ng (01/12)
apartment.move_in_date = date(2024, 12, 1)
bill = generate_management_fee_bill(session, apartment, date(2024, 12, 31))
# â†’ TÃ­nh FULL thÃ¡ng: 2,275,000Ä‘

# Case 2: Chuyá»ƒn vÃ o giá»¯a thÃ¡ng (15/12)
apartment.move_in_date = date(2024, 12, 15)
bill = generate_management_fee_bill(session, apartment, date(2024, 12, 31))
# â†’ TÃ­nh 17 ngÃ y: (2,275,000 / 31) Ã— 17 = 1,247,177.42Ä‘

# Case 3: Chuyá»ƒn vÃ o cuá»‘i thÃ¡ng (25/12)
apartment.move_in_date = date(2024, 12, 25)
bill = generate_management_fee_bill(session, apartment, date(2024, 12, 31))
# â†’ TÃ­nh 7 ngÃ y: (2,275,000 / 31) Ã— 7 = 513,709.68Ä‘
```

---

### 2. TÃ­nh phÃ­ gá»­i xe cÃ³ Pro-rata

```python
def generate_parking_fee_bill(
    session: Session,
    apartment: Apartment,
    vehicle_type: str,  # "car", "motorcycle", "bicycle"
    billing_month: date
):
    """
    Táº¡o hÃ³a Ä‘Æ¡n phÃ­ gá»­i xe (cÃ³ Ã¡p dá»¥ng Pro-rata)
    """
    from app.models.price_history import PriceType
    from app.core.utils import calculate_prorated_amount
    
    # 1. Láº¥y giÃ¡ gá»­i xe thÃ¡ng
    price_type_map = {
        "car": PriceType.PARKING_CAR,
        "motorcycle": PriceType.PARKING_MOTOR,
        "bicycle": PriceType.PARKING_BICYCLE,
    }
    
    monthly_fee = get_current_price(
        session=session,
        price_type=price_type_map[vehicle_type],
        reference_id=None
    )
    
    # 2. Ãp dá»¥ng Pro-rata
    amount = calculate_prorated_amount(
        monthly_fee=monthly_fee,
        billing_date=billing_month,
        move_in_date=apartment.move_in_date
    )
    
    # 3. Táº¡o Bill
    bill = Bill(
        bill_number=f"PK-{vehicle_type.upper()}-{apartment.apartment_number}-{billing_month.strftime('%Y%m')}",
        user_id=apartment.resident_id,
        bill_type=BillType.PARKING,
        title=f"PhÃ­ gá»­i xe {vehicle_type} thÃ¡ng {billing_month.month}/{billing_month.year}",
        amount=amount,
        due_date=billing_month + timedelta(days=15),
        status=BillStatus.PENDING
    )
    
    session.add(bill)
    session.commit()
    
    return bill


# ========== VÃ Dá»¤ ==========
# PhÃ­ gá»­i Ã´ tÃ´: 1,500,000Ä‘/thÃ¡ng
# Chuyá»ƒn vÃ o 20/12 â†’ á» 12 ngÃ y
bill = generate_parking_fee_bill(
    session,
    apartment,
    vehicle_type="car",
    billing_month=date(2024, 12, 31)
)
# Káº¿t quáº£: (1,500,000 / 31) Ã— 12 = 580,645.16Ä‘
```

---

### 3. TÃ­nh tiá»n Ä‘iá»‡n/nÆ°á»›c (KHÃ”NG Pro-rata)

```python
from app.core.utils import calculate_metered_consumption

def generate_utility_bill(
    session: Session,
    apartment: Apartment,
    meter_start: Decimal,
    meter_end: Decimal,
    utility_type: str  # "electricity" or "water"
):
    """
    Táº¡o hÃ³a Ä‘Æ¡n Ä‘iá»‡n/nÆ°á»›c (KHÃ”NG Ã¡p dá»¥ng Pro-rata)
    TÃ­nh theo chá»‰ sá»‘ cÃ´ng tÆ¡ thá»±c táº¿
    """
    # 1. Láº¥y Ä‘Æ¡n giÃ¡
    price_type = PriceType.ELECTRICITY_TIER_1 if utility_type == "electricity" else PriceType.WATER_TIER_1
    unit_price = get_current_price(session, price_type, None)
    
    # 2. TÃ­nh tiá»n theo tiÃªu thá»¥
    amount = calculate_metered_consumption(
        meter_start=meter_start,
        meter_end=meter_end,
        unit_price=unit_price
    )
    
    # 3. Táº¡o Bill
    unit = "kWh" if utility_type == "electricity" else "mÂ³"
    consumption = meter_end - meter_start
    
    bill = Bill(
        bill_number=f"UT-{utility_type.upper()}-{apartment.apartment_number}-202412",
        user_id=apartment.resident_id,
        bill_type=BillType.UTILITY,
        title=f"Tiá»n {utility_type} thÃ¡ng 12/2024",
        description=f"Chá»‰ sá»‘: {meter_start} â†’ {meter_end} ({consumption} {unit}) Ã— {unit_price:,}Ä‘",
        amount=amount,
        due_date=date(2024, 12, 31) + timedelta(days=15),
        status=BillStatus.PENDING
    )
    
    session.add(bill)
    session.commit()
    
    return bill


# ========== VÃ Dá»¤ ==========
# CÄƒn há»™ chuyá»ƒn vÃ o 15/12
apartment.move_in_date = date(2024, 12, 15)
apartment.electricity_meter_start = Decimal("0.00")  # Chá»‰ sá»‘ lÃºc bÃ n giao

# Cuá»‘i thÃ¡ng Ä‘á»c chá»‰ sá»‘: 50 kWh
meter_end = Decimal("50.00")

bill = generate_utility_bill(
    session,
    apartment,
    meter_start=apartment.electricity_meter_start,
    meter_end=meter_end,
    utility_type="electricity"
)
# Káº¿t quáº£: 50 kWh Ã— 1,806Ä‘ = 90,300Ä‘
# â†’ KHÃ”NG chia theo ngÃ y, tÃ­nh Ä‘á»§ tiÃªu thá»¥ thá»±c táº¿!
```

---

### 4. Táº¡o táº¥t cáº£ hÃ³a Ä‘Æ¡n thÃ¡ng (Auto Bill Generation)

```python
from sqlmodel import select

def generate_monthly_bills_for_all(session: Session, billing_month: date):
    """
    Táº¡o táº¥t cáº£ hÃ³a Ä‘Æ¡n cho thÃ¡ng (cháº¡y vÃ o ngÃ y 25 hÃ ng thÃ¡ng)
    """
    # Láº¥y táº¥t cáº£ cÄƒn há»™ Ä‘ang OCCUPIED
    stmt = select(Apartment).where(Apartment.status == ApartmentStatus.OCCUPIED)
    apartments = session.exec(stmt).all()
    
    bills_created = []
    
    for apt in apartments:
        if apt.resident_id is None:
            continue  # Bá» qua cÄƒn khÃ´ng cÃ³ cÆ° dÃ¢n
        
        # 1. Táº¡o hÃ³a Ä‘Æ¡n phÃ­ quáº£n lÃ½ (cÃ³ Pro-rata)
        mgmt_bill = generate_management_fee_bill(session, apt, billing_month)
        bills_created.append(mgmt_bill)
        
        # 2. Táº¡o hÃ³a Ä‘Æ¡n phÃ­ gá»­i xe (náº¿u cÃ³ - cÃ³ Pro-rata)
        # TODO: Kiá»ƒm tra cÆ° dÃ¢n cÃ³ Ä‘Äƒng kÃ½ xe khÃ´ng
        
        # 3. Táº¡o hÃ³a Ä‘Æ¡n Ä‘iá»‡n/nÆ°á»›c (KHÃ”NG Pro-rata)
        # TODO: Äá»c chá»‰ sá»‘ cÃ´ng tÆ¡ tá»« thiáº¿t bá»‹ IoT hoáº·c nháº­p tay
    
    print(f"âœ… ÄÃ£ táº¡o {len(bills_created)} hÃ³a Ä‘Æ¡n cho thÃ¡ng {billing_month.month}/{billing_month.year}")
    return bills_created


# ========== CHáº Y Tá»° Äá»˜NG Má»–I THÃNG ==========
# Scheduler: NgÃ y 25 hÃ ng thÃ¡ng
from datetime import date

billing_month = date(2024, 12, 31)  # Cuá»‘i thÃ¡ng 12
bills = generate_monthly_bills_for_all(session, billing_month)
```

---

## ğŸ“‹ Quy trÃ¬nh nghiá»‡p vá»¥

### Khi cÆ° dÃ¢n chuyá»ƒn vÃ o

1. **Admin bÃ n giao nhÃ ** (ngÃ y 15/12/2024):
   ```python
   apartment.status = ApartmentStatus.OCCUPIED
   apartment.resident_id = user.id
   apartment.move_in_date = date(2024, 12, 15)
   apartment.electricity_meter_start = Decimal("1250.00")  # Chá»‰ sá»‘ Ä‘iá»‡n
   apartment.water_meter_start = Decimal("85.50")  # Chá»‰ sá»‘ nÆ°á»›c
   session.commit()
   ```

2. **Há»‡ thá»‘ng tá»± Ä‘á»™ng**:
   - NgÃ y 25/12 â†’ Táº¡o hÃ³a Ä‘Æ¡n phÃ­ quáº£n lÃ½ (Pro-rata 17 ngÃ y)
   - NgÃ y 31/12 â†’ Äá»c chá»‰ sá»‘ Ä‘iá»‡n/nÆ°á»›c â†’ Táº¡o hÃ³a Ä‘Æ¡n tiá»‡n Ã­ch

3. **CÆ° dÃ¢n nháº­n hÃ³a Ä‘Æ¡n**:
   - PhÃ­ quáº£n lÃ½: 1,247,177Ä‘ (17/31 thÃ¡ng)
   - Äiá»‡n: TÃ­nh theo tiÃªu thá»¥ thá»±c táº¿ tá»« ngÃ y 15-31

### ThÃ¡ng tiáº¿p theo (ThÃ¡ng 1/2025)

```python
# ThÃ¡ng 1: CÆ° dÃ¢n Ä‘Ã£ á»Ÿ tá»« thÃ¡ng trÆ°á»›c
apartment.move_in_date = date(2024, 12, 15)  # Giá»¯ nguyÃªn

# Táº¡o bill thÃ¡ng 1
bill = generate_management_fee_bill(session, apartment, date(2025, 1, 31))
# â†’ TÃ­nh FULL thÃ¡ng 1 vÃ¬ move_in_date < 01/01/2025
```

---

## âš ï¸ LÆ°u Ã½ quan trá»ng

### 1. Sá»‘ ngÃ y trong thÃ¡ng KHÃ”NG Cá» Äá»ŠNH

```python
# âŒ SAI - Chia cá»©ng cho 30
daily_rate = monthly_fee / 30

# âœ… ÄÃšNG - DÃ¹ng calendar.monthrange
import calendar
_, num_days = calendar.monthrange(2024, 2)  # ThÃ¡ng 2/2024 = 29 ngÃ y
daily_rate = monthly_fee / num_days
```

### 2. Nhá»› cá»™ng 1 khi tÃ­nh sá»‘ ngÃ y

```python
# âŒ SAI
days_used = (last_day - start_date).days

# âœ… ÄÃšNG - TÃ­nh cáº£ ngÃ y chuyá»ƒn vÃ o
days_used = (last_day - start_date).days + 1
```

### 3. Äiá»‡n/NÆ°á»›c KHÃ”NG chia ngÃ y

```python
# âŒ SAI - Chia Pro-rata cho Ä‘iá»‡n
electricity_bill = calculate_prorated_amount(...)

# âœ… ÄÃšNG - TÃ­nh theo tiÃªu thá»¥
electricity_bill = calculate_metered_consumption(meter_start, meter_end, unit_price)
```

### 4. LÃ m trÃ²n Ä‘Ãºng cÃ¡ch

```python
from decimal import Decimal

# âœ… ÄÃšNG - DÃ¹ng Decimal vÃ  quantize
amount = Decimal("774193.5483870968")
rounded = amount.quantize(Decimal("0.01"))  # 774,193.55
```

---

## ğŸ¨ Hiá»ƒn thá»‹ trÃªn Frontend

### Component hiá»ƒn thá»‹ Bill

```typescript
interface Bill {
  id: number;
  title: string;
  amount: number;
  description: string;
  is_prorated: boolean;  // CÃ³ Ã¡p dá»¥ng Pro-rata khÃ´ng
  billing_period: string; // "ThÃ¡ng 12/2024"
}

function BillCard({ bill }: { bill: Bill }) {
  return (
    <Card>
      <h3>{bill.title}</h3>
      <p className="amount">{formatCurrency(bill.amount)}</p>
      
      {bill.is_prorated && (
        <Badge color="info">
          â±ï¸ TÃ­nh theo tá»· lá»‡ (Pro-rata)
        </Badge>
      )}
      
      <p className="description">{bill.description}</p>
    </Card>
  );
}
```

### Tooltip giáº£i thÃ­ch

```typescript
<Tooltip>
  <TooltipTrigger>
    <InfoIcon /> Táº¡i sao sá»‘ tiá»n láº»?
  </TooltipTrigger>
  <TooltipContent>
    PhÃ­ Ä‘Æ°á»£c tÃ­nh theo tá»· lá»‡ thá»i gian sá»­ dá»¥ng (Pro-rata).
    Báº¡n chuyá»ƒn vÃ o ngÃ y 15/12, chá»‰ pháº£i tráº£ 17/31 thÃ¡ng.
  </TooltipContent>
</Tooltip>
```

---

## ğŸ“Š Báº£ng tá»•ng há»£p cÃ¡c trÆ°á»ng há»£p

| NgÃ y chuyá»ƒn vÃ o | ThÃ¡ng | Sá»‘ ngÃ y | Tá»· lá»‡ | PhÃ­ quáº£n lÃ½ (2tr) | PhÃ­ gá»­i xe (1.5tr) |
|----------------|-------|---------|-------|-------------------|-------------------|
| 01/12/2024 | 12 (31 ngÃ y) | 31/31 | 100% | 2,000,000Ä‘ | 1,500,000Ä‘ |
| 05/12/2024 | 12 (31 ngÃ y) | 27/31 | 87% | 1,741,935Ä‘ | 1,306,452Ä‘ |
| 15/12/2024 | 12 (31 ngÃ y) | 17/31 | 55% | 1,096,774Ä‘ | 822,581Ä‘ |
| 20/12/2024 | 12 (31 ngÃ y) | 12/31 | 39% | 774,194Ä‘ | 580,645Ä‘ |
| 25/12/2024 | 12 (31 ngÃ y) | 7/31 | 23% | 451,613Ä‘ | 338,710Ä‘ |

---

## âœ… Checklist triá»ƒn khai

- [x] Táº¡o utility function `calculate_prorated_amount()`
- [x] ThÃªm field `move_in_date` vÃ o báº£ng `apartments`
- [x] ThÃªm field `electricity_meter_start`, `water_meter_start`
- [x] Cáº­p nháº­t seed data vá»›i move_in_date khÃ¡c nhau
- [ ] Táº¡o API endpoint `/admin/bills/generate-monthly`
- [ ] Táº¡o Scheduler cháº¡y tá»± Ä‘á»™ng ngÃ y 25
- [ ] Hiá»ƒn thá»‹ badge "Pro-rata" trÃªn frontend
- [ ] ThÃªm tooltip giáº£i thÃ­ch cho ngÆ°á»i dÃ¹ng
- [ ] Test case: ThÃ¡ng 2 (28/29 ngÃ y)
- [ ] Test case: Chuyá»ƒn vÃ o ngÃ y cuá»‘i thÃ¡ng

---

**âœ… Há»‡ thá»‘ng Pro-rata Ä‘Ã£ sáºµn sÃ ng!**
